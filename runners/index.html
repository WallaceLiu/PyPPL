<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Runners and running profiles - PyPPL</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Runners and running profiles";
    var mkdocs_page_input_path = "runners.md";
    var mkdocs_page_url = "/runners/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> PyPPL</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../basic-concepts-and-directory-structure/">Basics and folder structure</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../placeholders/">Templating</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../channels/">Channels</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../specify-input-and-output-of-a-process/">Input and output of a process</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../write-your-script/">The heart: script</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../export-output-files/">Output file exporting</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../caching/">Caching and resuming processes</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Runners and running profiles</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#runners-and-running-profiles">Runners and running profiles</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#running-profile">Running profile</a></li>
        
            <li><a class="toctree-l3" href="#defining-running-profiles">Defining running profiles</a></li>
        
            <li><a class="toctree-l3" href="#built-in-runners">Built-in runners</a></li>
        
            <li><a class="toctree-l3" href="#configurations-for-ssh-runner">Configurations for ssh runner</a></li>
        
            <li><a class="toctree-l3" href="#configurations-for-sge-runner">Configurations for sge runner</a></li>
        
            <li><a class="toctree-l3" href="#configurations-for-slurm-runner">Configurations for slurm runner</a></li>
        
            <li><a class="toctree-l3" href="#dry-run-a-pipeline">Dry-run a pipeline</a></li>
        
            <li><a class="toctree-l3" href="#define-your-own-runner">Define your own runner</a></li>
        
            <li><a class="toctree-l3" href="#register-your-runner">Register your runner</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../error-handling/">Error handling of processes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../set-other-properties-of-a-process/">Other attributes of a process</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../configure-your-logs/">Log configuration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../draw-flowchart-of-a-pipeline/">Pipeline flowchart</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../configure-a-pipeline/">Pipeline configuration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../command-line-argument-parser/">Command line argument parser</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../aggregations/">Aggregations</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../command-line-tool/">Command line tool</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../api/">API</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../faq/">FAQ</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../change-log/">Change log</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">PyPPL</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Runners and running profiles</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="runners-and-running-profiles">Runners and running profiles</h1>
<h2 id="running-profile">Running profile</h2>
<p>A running profile defines the parameters that needed for a pipeline to run. Generally it contains the runner, the parameters for the runner and the common settings for the processes.
A typical running profile is as follows:
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;runner&#39;</span><span class="p">:</span> <span class="s1">&#39;sge&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sgeRunner&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;1-day&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;forks&#39;</span><span class="p">:</span> <span class="mi">32</span>
<span class="p">}</span>
</pre></div></p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>You may also put other settings of processes into a running profile, but keep in mind:
1. The value will not be overridden if the attribute is set explicitly (i.e: <code>p.forks = 10</code>)
2. Only set common attributes for all processes in a pipeline to avoid unexprected behavior. For example, you probably don't want this in general cases to set the same script for all processes: 
<div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="s1">&#39;file:/path/to/script&#39;</span>
<span class="p">}</span>
</pre></div></p>
</div>
<h2 id="defining-running-profiles">Defining running profiles</h2>
<p>You may pre-define some profiles so that you can easily swith them by:
<div class="highlight"><pre><span></span><span class="n">PyPPL</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">pXXX</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;profile1&#39;</span><span class="p">)</span>
<span class="n">PyPPL</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">pXXX</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;profile2&#39;</span><span class="p">)</span>
</pre></div>
You can define profiles in <code>PyPPL</code>'s default configuration files: <code>$HOME/.PyPPL.yaml</code>, <code>$HOME/.PyPPL</code> and/or <code>$HOME/.PyPPL.json</code>. The latter ones have high priorities. <code>$HOME/.PyPPL</code> should also be in <code>JSON</code> format. Take <code>$HOME/.PyPPL.yaml</code> (requiring <code>pyyaml</code>) for example, the content is like:
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> 
    <span class="l l-Scalar l-Scalar-Plain">runner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
    <span class="l l-Scalar l-Scalar-Plain">forks</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="l l-Scalar l-Scalar-Plain">echo</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">stderr</span>
<span class="l l-Scalar l-Scalar-Plain">profile1</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">runner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sge</span>
    <span class="l l-Scalar l-Scalar-Plain">sgeRunner</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1-day</span>
<span class="l l-Scalar l-Scalar-Plain">profile2</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">runner</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sge</span>
    <span class="l l-Scalar l-Scalar-Plain">sgeRunner</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">7-days</span>
</pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a <code>key</code> is not in a profile, then it will be inherited from <code>default</code>.</p>
</div>
<p>You may also define some profiles in a file somewhere else, say <code>/path/to/myprofiles.yaml</code>. Just pass the file to <code>PyPPL</code> constructor:
<div class="highlight"><pre><span></span><span class="n">PyPPL</span><span class="p">(</span><span class="n">cfgfile</span> <span class="o">=</span> <span class="s1">&#39;/path/to/myprofiles.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">pXXX</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;profile1&#39;</span><span class="p">)</span>
</pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This has higher priority than default configuration files.</p>
</div>
<p>You can also pass the profiles to <code>PyPPL</code> constructor directly:
<div class="highlight"><pre><span></span><span class="n">PyPPL</span><span class="p">({</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;runner&#39;</span><span class="p">:</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span>
        <span class="s1">&#39;forks&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;echo&#39;</span><span class="p">:</span> <span class="s1">&#39;stderr&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;profile1&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;runner&#39;</span><span class="p">:</span> <span class="s1">&#39;sge&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sgeRunner&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;1-day&#39;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">&#39;profile2&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;runner&#39;</span><span class="p">:</span> <span class="s1">&#39;sge&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sgeRunner&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;7-days&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">pXXX</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;profile1&#39;</span><span class="p">)</span>
</pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this way, the profiles have higher priorities than the ones defined in configuration files.</p>
</div>
<p>Or even, you can also specify a profile to <code>run</code> function to ask the pipeline run with the profile directly:
<div class="highlight"><pre><span></span><span class="n">PyPPL</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">pXXX</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">({</span>
    <span class="s1">&#39;runner&#39;</span><span class="p">:</span> <span class="s1">&#39;sge&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sgeRunner&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;1-day&#39;</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This has the highest priority.</p>
</div>
<h2 id="built-in-runners">Built-in runners</h2>
<p>We have 5 built-in runners (<code>RunnerLocal</code>, <code>RunnerSsh</code>, <code>RunnerSge</code>, <code>RunnerSlurm</code>, <code>runnerDry</code>), you can also define you own runners.</p>
<p>You can either tell one process to use a runner, or even, you can tell the pipeline to use one runner for all the processes. That means each process can have the same runner or a different one. To tell a process which runner to use, just specify the runner name to <code>pXXX.runner</code> (for example, <code>pXXX.runner = "sge"</code> to use the sge runner). Each process may use different configuration for the runner (<code>pXXX.sgeRunner</code>) or the same one by <a href="https://pwwang.gitbooks.io/pyppl/content/configure-a-pipeline.html">configuring the pipeline</a>.</p>
<h2 id="configurations-for-ssh-runner">Configurations for ssh runner</h2>
<p>Ssh runner takes the advantage to use the computing resources from other servers that can be connected via <code>ssh</code>. The <code>ssh</code> command allows us to pass the command to the server and execute it: <code>ssh [options] [command]</code></p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<ol>
<li>ssh runner only works when the servers share the same file system.</li>
<li>you have to <a href="http://www.linuxproblem.org/art_9.html">configure</a> so that you don't need a password to log onto the servers, or use a private key to connect to the ssh servers.</li>
<li>The jobs will be distributed equally to the servers.</li>
</ol>
</div>
<p>To tell a process the available ssh servers:
<div class="highlight"><pre><span></span><span class="n">pXXX</span><span class="o">.</span><span class="n">sshRunner</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;servers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;server1&quot;</span><span class="p">,</span> <span class="s2">&quot;server2&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> 
    <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/path/to/keyfile1&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/keyfile2&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="p">}</span>
</pre></div></p>
<p>You can have complicated ssh configurations which can be set by the system ssh config subsystem:</p>
<p><code>$HOME/.ssh/config</code>:
<div class="highlight"><pre><span></span># contents of $HOME/.ssh/config
Host dev
    HostName dev.example.com
    Port 22000
    User fooey
</pre></div></p>
<p>If you use different usernames to log on the servers, you may also specify the usernames as well:
<div class="highlight"><pre><span></span><span class="n">pXXX</span><span class="o">.</span><span class="n">sshRunner</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;servers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user1@server1&quot;</span><span class="p">,</span> <span class="s2">&quot;user2@server2&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]}</span>
</pre></div></p>
<p>You can also add <code>preScript</code> and <code>postScript</code> for all jobs:
<div class="highlight"><pre><span></span><span class="n">pXXX</span><span class="o">.</span><span class="n">sshRunner</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;servers&quot;</span><span class="p">:[</span><span class="o">...</span><span class="p">],</span> 
    <span class="s2">&quot;preScript&quot;</span><span class="p">:</span> <span class="s2">&quot;mkdir some/dir/to/be/made&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;postScript&quot;</span><span class="p">:</span> <span class="s2">&quot;rm -rf /path/to/job/tmp/dir&quot;</span>
<span class="p">}</span>
</pre></div></p>
<p>To make a running profile with it for a pipeline for all processes:
<div class="highlight"><pre><span></span><span class="n">PyPPL</span> <span class="p">({</span>
    <span class="c1"># default profile</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;sshRunner&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;servers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user1@server1&quot;</span><span class="p">,</span> <span class="s2">&quot;user2@server2&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]}</span>
    <span class="p">},</span>
    <span class="s1">&#39;ssh3&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;runner&#39;</span><span class="p">:</span> <span class="s1">&#39;ssh&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sshRunner&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;servers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;server1&quot;</span><span class="p">,</span> <span class="s2">&quot;server2&quot;</span><span class="p">,</span> <span class="s2">&quot;server3&quot;</span><span class="p">],</span>
            <span class="s2">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/path/to/key1&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/key2&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/key3&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
Also see "<a href="https://pwwang.github.io/pyppl/content/configure-a-pipeline.html">pipeline configration</a>" for more details.</p>
<p>The constructor of the runner will change the actual script to run the following (<code>&lt;workdir&gt;/0/job.script.ssh</code>):</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="nb">trap</span> <span class="s2">&quot;status=\$?; echo \$status &gt; &lt;workdir&gt;/scripts/script.0.rc; exit \$status&quot;</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> EXIT
ssh -i <span class="s2">&quot;/path/to/key1&quot;</span> user1@server1 <span class="s2">&quot;cd &lt;cwd&gt;; &lt;workdir&gt;/0/job.script&quot;</span>
</pre></div>

<p><code>trap</code> command makes sure a return code file will be generated. </p>
<h2 id="configurations-for-sge-runner">Configurations for sge runner</h2>
<p>Similarly, you can also submit your jobs to SGE servers using <code>qsub</code>. To set the options for a process:
<div class="highlight"><pre><span></span><span class="n">pXXX</span><span class="o">.</span><span class="n">sgeRunner</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;sge.q&quot;</span> <span class="p">:</span> <span class="s2">&quot;1-day&quot;</span><span class="p">,</span>          <span class="c1"># the queue</span>
    <span class="s2">&quot;sge.M&quot;</span> <span class="p">:</span> <span class="s2">&quot;user@domain.com&quot;</span><span class="p">,</span><span class="c1"># The email for notification</span>
    <span class="s2">&quot;sge.l&quot;</span> <span class="p">:</span> <span class="s2">&quot;h_vmem=4G&quot;</span><span class="p">,</span>        
    <span class="s2">&quot;sge.l &quot;</span><span class="p">:</span> <span class="s2">&quot;h_stack=512M&quot;</span><span class="p">,</span>   <span class="c1"># Remember to add an extra space </span>
                                <span class="c1"># so that it won&#39;t override the previous &quot;sge.l&quot;</span>
    <span class="s2">&quot;sge.m&quot;</span> <span class="p">:</span> <span class="s2">&quot;abe&quot;</span><span class="p">,</span>            <span class="c1"># When to notify</span>
    <span class="s2">&quot;sge.notify&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s2">&quot;preScript&quot;</span><span class="p">:</span>  <span class="s2">&quot;source /home/user/.bash_profile &gt;&amp;/dev/null; mkdir /tmp/my&quot;</span><span class="p">,</span>  <span class="c1"># load the environment and create the temporary directory</span>
    <span class="s2">&quot;postScript&quot;</span><span class="p">:</span> <span class="s2">&quot;rm -rf /tmp/my&quot;</span> <span class="c1"># clean up</span>
<span class="p">}</span>
</pre></div>
Please check <code>man qsub</code> to find other options. Remember to add a <code>sge.</code> prefix to the option name.</p>
<p>To make a running profile with it for a pipeline for all processes:
<div class="highlight"><pre><span></span><span class="n">PyPPL</span><span class="p">({</span>
    <span class="s1">&#39;proc&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;sgeRunner&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1">#...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</pre></div>
Also see "<a href="https://pwwang.gitbooks.io/pyppl/content/configure-a-pipeline.html">pipeline configuration</a>" for more details.</p>
<p>The constructor of the runner will change the script to run to the following (<code>&lt;workdir&gt;/0/job.script.sge</code>):
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="c1">#$ -N &lt;id&gt;.&lt;tag&gt;.0</span>
<span class="c1">#$ -q 1-day</span>
<span class="c1">#$ -o &lt;workdir&gt;/PyPPL.pMuTect2.nothread.51SoVk6Y/0/job.stdout</span>
<span class="c1">#$ -e &lt;workdir&gt;/PyPPL.pMuTect2.nothread.51SoVk6Y/0/job.stderr</span>
<span class="c1">#$ -cwd</span>
<span class="c1">#$ -M wang.panwen@mayo.edu</span>
<span class="c1">#$ -m abe</span>
<span class="c1">#$ -l h_vmem=4G</span>
<span class="c1">#$ -l h_stack=512M</span>
<span class="c1">#$ -notify</span>

<span class="nb">trap</span> <span class="s2">&quot;status=\$?; echo \$status &gt; &lt;workdir&gt;/0/job.rc; exit \$status&quot;</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span> <span class="m">15</span> <span class="m">16</span> <span class="m">17</span> EXIT
<span class="nb">source</span> /home/whoever/.bash_profile &gt;<span class="p">&amp;</span>/dev/null<span class="p">;</span> mkdir /tmp/my

&lt;workdir&gt;/0/job.script
rm -rf /tmp/my
</pre></div></p>
<h2 id="configurations-for-slurm-runner">Configurations for slurm runner</h2>
<p><strong>Where to configure it:</strong>
For single process:
<div class="highlight"><pre><span></span><span class="n">pXXX</span><span class="o">.</span><span class="n">slurmRunner</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
</pre></div>
For running profiles:
<div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;proc&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="o">...</span> <span class="c1"># other configurations</span>
    <span class="s2">&quot;runner&quot;</span><span class="p">:</span> <span class="s2">&quot;slurm&quot;</span><span class="p">,</span> <span class="c1"># all processes run with slurm</span>
    <span class="s2">&quot;slurmRunner&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="o">...</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="c1"># or you can also create a profile</span>
  <span class="s2">&quot;runWithSlurm&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="o">...</span> <span class="c1"># other configurations</span>
    <span class="s2">&quot;runner&quot;</span><span class="p">:</span> <span class="s2">&quot;slurm&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;slurmRunner&quot;</span><span class="p">:</span> <span class="p">{</span>
       <span class="o">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">PyPPL</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c1"># uses configurations of &#39;proc&#39;</span>
<span class="c1"># for profile:</span>
<span class="c1"># PyPPL(config).start(...).run(&#39;runWithSlurm&#39;)</span>
</pre></div></p>
<p><strong>The full configuration:</strong>
<div class="highlight"><pre><span></span><span class="s2">&quot;slurmRunner&quot;</span><span class="o">:</span> <span class="p">{</span>
  <span class="s2">&quot;preScript&quot;</span><span class="o">:</span> <span class="s2">&quot;export PATH=$PATH:/path/to/add&quot;</span><span class="p">,</span> <span class="c1">// default: &#39;&#39;</span>
  <span class="s2">&quot;postScript&quot;</span><span class="o">:</span> <span class="s2">&quot;# some cleanup&quot;</span><span class="p">,</span>                <span class="c1">// default: &#39;&#39;</span>
  <span class="c1">// commands (some slurm systems have variants of commands)</span>
  <span class="s2">&quot;sbatch&quot;</span><span class="o">:</span> <span class="s2">&quot;yhbatch&quot;</span><span class="p">,</span>                           <span class="c1">// default: sbatch</span>
  <span class="s2">&quot;srun&quot;</span><span class="o">:</span> <span class="s2">&quot;yhrun&quot;</span><span class="p">,</span>                               <span class="c1">// default: srun</span>
  <span class="s2">&quot;squeue&quot;</span><span class="o">:</span> <span class="s2">&quot;yhqueue&quot;</span><span class="p">,</span>                           <span class="c1">// default: squeue</span>
  <span class="c1">// the prefix add to command you want to run</span>
  <span class="c1">// i.e &quot;srun -n8 hostname&quot;</span>
  <span class="c1">// it defaults to the command you specified to slurmRunner[&#39;srun&#39;]</span>
  <span class="c1">// In this case: &quot;yhrun&quot;</span>
  <span class="s2">&quot;cmdPrefix&quot;</span><span class="o">:</span> <span class="s2">&quot;srun -n8&quot;</span><span class="p">,</span>                       <span class="c1">// default: slurmRunner[&#39;srun&#39;]</span>
  <span class="c1">// sbatch options (with prefix &quot;slurm.&quot;):</span>
  <span class="s2">&quot;slurm.p&quot;</span><span class="o">:</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span>
  <span class="s2">&quot;slurm.mem&quot;</span><span class="o">:</span> <span class="s2">&quot;1GB&quot;</span><span class="p">,</span>
  <span class="c1">// other options</span>
  <span class="c1">// ......</span>
  <span class="c1">// Note that job name (slurm.J), stdout (slurm.o), stderr file (slurm.e) is calculated by the runner.</span>
  <span class="c1">// Although you can, you are not recommended to set them here.</span>
<span class="p">}</span>
</pre></div></p>
<h2 id="dry-run-a-pipeline">Dry-run a pipeline</h2>
<p>You can use dry runner to dry-run a pipeline. The real script will not be running, instead, it just tries to touch the output files and create the output directories.</p>
<div class="admonition note">
<p class="admonition-title">When <code>RunnerDry</code> is being used</p>
<ul>
<li>All processes are running on local machine.</li>
<li>Expectations won't be checked.</li>
<li>Processes won't be cached.</li>
<li>Output files/directories won't be exported.</li>
<li>Better set runner of all processes in a pipeline to <code>dry</code>. (<code>pyppl().starts(...).run('dry')</code>), since empty file/directory will be created for output. Problems will happen if you have a non-dry-run process depending on dry-run processes.</li>
</ul>
</div>
<h2 id="define-your-own-runner">Define your own runner</h2>
<p>You are also able to define your own runner, which should be a class extends <code>Runner</code> (jobs run immediately after submission) or <code>RunnerQueue</code> (jobs are put into a queue after submission). There are several methods and variables you may need to redefine (You may check the <a href="https://pwwang.gitbooks.io/pyppl/content/API.html#runner">API documentation</a> for all available methods and variables).</p>
<p>The class name <strong>MUST</strong> start with <code>Runner</code> and end with the runner name with first letter capitalized. For example, to define the runner <code>my</code>:
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyppl.runners</span> <span class="kn">import</span> <span class="n">Runner</span>
<span class="k">class</span> <span class="nc">RunnerMy</span> <span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
	<span class="k">pass</span>
</pre></div></p>
<p>The base class <code>Runner</code> defines the runners where the jobs will immediately run after submission; while <code>RunnerQueue</code> defines the runners where the jobs will be put into a queue and wait for its turn to run (for example, clusters).</p>
<p>Some important method to be redefined:</p>
<div class="admonition hint">
<p class="admonition-title">Checklist (What you have to do in the constructor redefinition)</p>
<ul>
<li>choose the right base class (<code>pyppl.runners.Runner</code> or <code>pyppl.runners.RunnerQueue</code>)</li>
<li><code>super(RunnerMy, self).__init__(job)</code></li>
<li>setup the right <code>self.script</code> for submission.</li>
<li>MAKE SURE you save the identity of the job to <code>job.pidfile</code>, rc to <code>job.rcfile</code>, stdout to <code>job.outfile</code> and <code>stderr</code> to <code>job.errfile</code></li>
</ul>
</div>
<ul>
<li>
<p>Get the job identity on the system: <code>getpid()</code>
  Sometimes you cannot determin the job identity (e.g. <code>pid</code> for local jobs) when you are composing the script file. For example, for <code>SGE</code> runner, only after you submit the job, the job id will be saved in <code>job.pidfile</code>. In this case, you have to parse the job identity from <code>job.outfile</code>. Then you may save it by <code>self.job.pid(&lt;jobid&gt;)</code>.<br />
  The purpose to save the job identity is to tell whether the job is already running before we submit the job. So you can ignore this, but the same job may be submitted twice. 
  Also see <code>isRunning</code> below.</p>
</li>
<li>
<p>Tell whether a job is still running: <code>isRunning(self)</code><br />
    This function is used to detect whether a job is running. 
    Basically, it uses the job id got by <code>getpid()</code> to tell whether the job is still running.
    <strong>This function is specially useful when you try to run the pipeline again if some of the jobs are still running but the main thread (pipeline) quite unintentionally.</strong><br />
    But it's optional, you can make the function always return <code>False</code>. Then the jobs are anyway to be submitted. In this case, <code>getpid</code> redefinition is not needed.</p>
</li>
<li>
<p>How many jobs to submit at one time (static variable): <code>maxsubmit</code> (WILL BE DEPRECATED!)
    This variable defines how many jobs to submit at one time. It defaults to <code>multiprocessing.cpu_count()/2</code> if you don't have the value for your runner, which means it will use half of the cpus to submit the jobs you want to run simultaneously at one time. Then wait for sometime (<code>interval</code>, see below), and submit another batch. The purpose is to avoid local machine to get stuck if you have too many jobs to submit.</p>
</li>
</ul>
<p><strong>Key points in writing your own runner</strong>:</p>
<ol>
<li>Choose the right base class (<code>pyppl.runners.Runner</code> or <code>pyppl.runners.RunnerQueue</code>) (required).</li>
<li>Compose the right script to submit the job (<code>self.script</code>) in <code>__init__</code>(required).</li>
<li>Use <code>getpid</code> to get the job id (optional).</li>
<li>Tell <code>PyPPL</code> how to judge when the jobs are still running (<code>self.isRunning()</code>) (optional). </li>
<li>MAKE SURE you save the identity of the job to <code>job.pidfile</code>, rc to <code>job.rcfile</code>, stdout to <code>job.outfile</code> and <code>stderr</code> to <code>job.errfile</code></li>
</ol>
<h2 id="register-your-runner">Register your runner</h2>
<p>It very easy to register your runner, just do <code>PyPPL.registerRunner (RunnerMy)</code> (static method) before you start to run the pipeline.
The 5 built-in runners have already been registered: 
<div class="highlight"><pre><span></span><span class="n">PyPPL</span><span class="o">.</span><span class="n">registerRunner</span> <span class="p">(</span><span class="n">RunnerLocal</span><span class="p">)</span>
<span class="n">PyPPL</span><span class="o">.</span><span class="n">registerRunner</span> <span class="p">(</span><span class="n">RunnerSsh</span><span class="p">)</span>
<span class="n">PyPPL</span><span class="o">.</span><span class="n">registerRunner</span> <span class="p">(</span><span class="n">RunnerSge</span><span class="p">)</span>
<span class="n">PyPPL</span><span class="o">.</span><span class="n">registerRunner</span> <span class="p">(</span><span class="n">RunnerSlurm</span><span class="p">)</span>
<span class="n">PyPPL</span><span class="o">.</span><span class="n">registerRunner</span> <span class="p">(</span><span class="n">RunnerDry</span><span class="p">)</span>
</pre></div>
To register yours:
<div class="highlight"><pre><span></span><span class="n">PyPPL</span><span class="o">.</span><span class="n">registerRunner</span><span class="p">(</span><span class="n">RunnerMy</span><span class="p">)</span>
</pre></div>
After registration, you are able to ask a process to use it: <code>pXXX.runner = "my"</code></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../error-handling/" class="btn btn-neutral float-right" title="Error handling of processes">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../caching/" class="btn btn-neutral" title="Caching and resuming processes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../caching/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../error-handling/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
