<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Runners - PyPPL</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Runners";
    var mkdocs_page_input_path = "runners.md";
    var mkdocs_page_url = "/runners/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../README/" class="icon icon-home"> PyPPL</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../README/">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../basic-concepts-and-directory-structure/">Basics and folder structure</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../placeholders/">Templating</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../channels/">Channels</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../specify-input-and-output-of-a-process/">Input and output of a process</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../write-your-script/">The heart: script</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../export-output-files/">Output file exporting</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../caching/">Caching and resuming processes</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Runners</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#runners">Runners</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#configurations-for-ssh-runner">Configurations for ssh runner</a></li>
        
            <li><a class="toctree-l3" href="#configurations-for-sge-runner">Configurations for sge runner</a></li>
        
            <li><a class="toctree-l3" href="#configurations-for-slurm-runner">Configurations for slurm runner</a></li>
        
            <li><a class="toctree-l3" href="#dry-run-a-pipeline">Dry-run a pipeline</a></li>
        
            <li><a class="toctree-l3" href="#define-your-own-runner">Define your own runner</a></li>
        
            <li><a class="toctree-l3" href="#register-your-runner">Register your runner</a></li>
        
            <li><a class="toctree-l3" href="#use-different-runners">Use different runners</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../set-other-properties-of-a-process/">Other attributes of a process</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../configure-your-logs/">Log configuration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../configure-a-pipeline/">Pipeline configuration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../draw-flowchart-of-a-pipeline/">Pipeline flowchart</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../command-line-argument-parser/">Command line argument parser</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../aggregations/">Aggregations</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../command-line-tool/">Command line tool</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../api/">API</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../faq/">FAQ</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../change-log/">Change log</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../README/">PyPPL</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../README/">Docs</a> &raquo;</li>
    
      
    
    <li>Runners</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="runners">Runners</h1>
<!-- toc -->

<p>{% raw %}
We have 5 built-in runners (<code>RunnerLocal</code>, <code>RunnerSsh</code>, <code>RunnerSge</code>, <code>RunnerSlurm</code>, <code>runnerDry</code>), you can also define you own runners.</p>
<p>You can either tell one process to use a runner, or even, you can tell the pipeline to use one runner for all the processes. That means each process can have the same runner or a different one. To tell a process which runner to use, just specify the runner name to <code>pXXX.runner</code> (for example, <code>pXXX.runner = "sge"</code> to use the sge runner). Each process may use different configuration for the runner (<code>pXXX.sgeRunner</code>) or the same one by <a href="https://pwwang.gitbooks.io/pyppl/content/configure-a-pipeline.html">configuring the pipeline</a>.</p>
<h2 id="configurations-for-ssh-runner">Configurations for ssh runner</h2>
<p>Ssh runner takes the advantage to use the computing resources from other servers that can be connected via <code>ssh</code>. The <code>ssh</code> command allows us to pass the command to the server and execute it: <code>ssh [options] [command]</code></p>
<blockquote>
<p><strong>Caution</strong> 
1. ssh runner only works when the servers share the same file system.
2. you have to <a href="http://www.linuxproblem.org/art_9.html">configure</a> so that you don't need a password to log onto the servers, or use a private key to connect to the ssh servers.
3. The jobs will be distributed equally to the servers.</p>
</blockquote>
<p>To tell a process the available ssh servers:</p>
<pre><code class="python">pXXX.sshRunner = {
    &quot;servers&quot;: [&quot;server1&quot;, &quot;server2&quot;, ...], 
    &quot;keys&quot;: [&quot;/path/to/keyfile1&quot;, &quot;/path/to/keyfile2&quot;, ...]
}
</code></pre>

<p>You can have complicated ssh configurations which can be set by the system ssh config subsystem:</p>
<p><code>$HOME/.ssh/config</code>:</p>
<pre><code># contents of $HOME/.ssh/config
Host dev
    HostName dev.example.com
    Port 22000
    User fooey
</code></pre>

<p>If you use different usernames to log on the servers, you may also specify the usernames as well:</p>
<pre><code class="python">pXXX.sshRunner = {&quot;servers&quot;: [&quot;user1@server1&quot;, &quot;user2@server2&quot;, ...]}
</code></pre>

<p>You can also add <code>preScript</code> and <code>postScript</code> for all jobs:</p>
<pre><code class="python">pXXX.sshRunner = {
    &quot;servers&quot;:[...], 
    &quot;preScript&quot;: &quot;mkdir some/dir/to/be/made&quot;, 
    &quot;postScript&quot;: &quot;rm -rf /path/to/job/tmp/dir&quot;
}
</code></pre>

<p>To make a running profile with it for a pipeline for all processes:</p>
<pre><code class="python">PyPPL ({
    # default profile
    'proc': {
        'sshRunner': {&quot;servers&quot;: [&quot;user1@server1&quot;, &quot;user2@server2&quot;, ...]}
    },
    'ssh3': {
        'runner': 'ssh',
        'sshRunner': {
            &quot;servers&quot;: [&quot;server1&quot;, &quot;server2&quot;, &quot;server3&quot;],
            &quot;keys&quot;: [&quot;/path/to/key1&quot;, &quot;/path/to/key2&quot;, &quot;/path/to/key3&quot;]
        }
    }
})
</code></pre>

<p>Also see "<a href="https://pwwang.gitbooks.io/pyppl/content/configure-a-pipeline.html">pipeline configration</a>" for more details.</p>
<p>The constructor of the runner will change the actual script to run the following (<code>&lt;workdir&gt;/0/job.script.ssh</code>):</p>
<pre><code class="bash">#!/usr/bin/env bash
trap &quot;status=\$?; echo \$status &gt; &lt;workdir&gt;/scripts/script.0.rc; exit \$status&quot; 1 2 3 6 7 8 9 10 11 12 15 16 17 EXIT
ssh -i &quot;/path/to/key1&quot; user1@server1 &quot;cd &lt;cwd&gt;; &lt;workdir&gt;/0/job.script&quot;
</code></pre>

<p><code>trap</code> command makes sure a return code file will be generated. </p>
<h2 id="configurations-for-sge-runner">Configurations for sge runner</h2>
<p>Similarly, you can also submit your jobs to SGE servers using <code>qsub</code>. To set the options for a process:</p>
<pre><code class="python">pXXX.sgeRunner = {
    &quot;sge.q&quot; : &quot;1-day&quot;,          # the queue
    &quot;sge.M&quot; : &quot;user@domain.com&quot;,# The email for notification
    &quot;sge.l&quot; : &quot;h_vmem=4G&quot;,        
    &quot;sge.l &quot;: &quot;h_stack=512M&quot;,   # Remember to add an extra space 
                                # so that it won't override the previous &quot;sge.l&quot;
    &quot;sge.m&quot; : &quot;abe&quot;,            # When to notify
    &quot;sge.notify&quot;: True,
    &quot;preScript&quot;:  &quot;source /home/user/.bash_profile &gt;&amp;/dev/null; mkdir /tmp/my&quot;,  # load the environment and create the temporary directory
    &quot;postScript&quot;: &quot;rm -rf /tmp/my&quot; # clean up
}
</code></pre>

<p>Please check <code>man qsub</code> to find other options. Remember to add a <code>sge.</code> prefix to the option name.</p>
<p>To make a running profile with it for a pipeline for all processes:</p>
<pre><code class="python">PyPPL({
    'proc': {
        'sgeRunner': {
            #...
        }
    }
})
</code></pre>

<p>Also see "<a href="https://pwwang.gitbooks.io/pyppl/content/configure-a-pipeline.html">pipeline configuration</a>" for more details.</p>
<p>The constructor of the runner will change the script to run to the following (<code>&lt;workdir&gt;/0/job.script.sge</code>):</p>
<pre><code class="bash">#!/usr/bin/env bash
#$ -N &lt;id&gt;.&lt;tag&gt;.0
#$ -q 1-day
#$ -o &lt;workdir&gt;/PyPPL.pMuTect2.nothread.51SoVk6Y/0/job.stdout
#$ -e &lt;workdir&gt;/PyPPL.pMuTect2.nothread.51SoVk6Y/0/job.stderr
#$ -cwd
#$ -M wang.panwen@mayo.edu
#$ -m abe
#$ -l h_vmem=4G
#$ -l h_stack=512M
#$ -notify

trap &quot;status=\$?; echo \$status &gt; &lt;workdir&gt;/0/job.rc; exit \$status&quot; 1 2 3 6 7 8 9 10 11 12 15 16 17 EXIT
source /home/whoever/.bash_profile &gt;&amp;/dev/null; mkdir /tmp/my

&lt;workdir&gt;/0/job.script
rm -rf /tmp/my
</code></pre>

<h2 id="configurations-for-slurm-runner">Configurations for slurm runner</h2>
<p><strong>Where to configure it:</strong>
For single process:</p>
<pre><code class="python">pXXX.slurmRunner = {...}
</code></pre>

<p>For running profiles:</p>
<pre><code class="python">config = {
  &quot;proc&quot;: {
    ... # other configurations
    &quot;runner&quot;: &quot;slurm&quot;, # all processes run with slurm
    &quot;slurmRunner&quot;: {
       ...
    }
  }, # or you can also create a profile
  &quot;runWithSlurm&quot;: {
    ... # other configurations
    &quot;runner&quot;: &quot;slurm&quot;, 
    &quot;slurmRunner&quot;: {
       ...
    }
  }
}
PyPPL(config).start(...).run() # uses configurations of 'proc'
# for profile:
# PyPPL(config).start(...).run('runWithSlurm')
</code></pre>

<p><strong>The full configuration:</strong></p>
<pre><code class="javascript">&quot;slurmRunner&quot;: {
  &quot;preScript&quot;: &quot;export PATH=$PATH:/path/to/add&quot;, // default: ''
  &quot;postScript&quot;: &quot;# some cleanup&quot;,                // default: ''
  // commands (some slurm systems have variants of commands)
  &quot;sbatch&quot;: &quot;yhbatch&quot;,                           // default: sbatch
  &quot;srun&quot;: &quot;yhrun&quot;,                               // default: srun
  &quot;squeue&quot;: &quot;yhqueue&quot;,                           // default: squeue
  // the prefix add to command you want to run
  // i.e &quot;srun -n8 hostname&quot;
  // it defaults to the command you specified to slurmRunner['srun']
  // In this case: &quot;yhrun&quot;
  &quot;cmdPrefix&quot;: &quot;srun -n8&quot;,                       // default: slurmRunner['srun']
  // sbatch options (with prefix &quot;slurm.&quot;):
  &quot;slurm.p&quot;: &quot;normal&quot;,
  &quot;slurm.mem&quot;: &quot;1GB&quot;,
  // other options
  // ......
  // Note that job name (slurm.J), stdout (slurm.o), stderr file (slurm.e) is calculated by the runner.
  // Although you can, you are not recommended to set them here.
}
</code></pre>

<h2 id="dry-run-a-pipeline">Dry-run a pipeline</h2>
<p>You can use dry runner to dry-run a pipeline. The real script will not be running, instead, it just tries to touch the output files and create the output directories.</p>
<blockquote>
<p><strong>NOTE</strong>: when <code>RunnerDry</code> is being used:
- All processes are running on local machine.
- Expectations won't be checked.
- Processes won't be cached.
- Output files/directories won't be exported.
- Better set runner of all processes in a pipeline to <code>dry</code>. (<code>pyppl().starts(...).run('dry')</code>), since empty file/directory will be created for output. Problems will happen if you have a non-dry-run process depending on dry-run processes.</p>
</blockquote>
<h2 id="define-your-own-runner">Define your own runner</h2>
<p>You are also able to define your own runner, which should be a class extends <code>Runner</code> (jobs run immediately after submission) or <code>RunnerQueue</code> (jobs are put into a queue after submission). There are several methods and variables you may need to redefine (You may check the <a href="https://pwwang.gitbooks.io/pyppl/content/API.html#runner">API documentation</a> for all available methods and variables).</p>
<p>The class name <strong>MUST</strong> start with <code>Runner</code> and end with the runner name with first letter capitalized. For example, to define the runner <code>my</code>:</p>
<pre><code class="python">from pyppl.runners import Runner
class RunnerMy (Runner):
    pass
</code></pre>

<p>The base class <code>Runner</code> defines the runners where the jobs will immediately run after submission; while <code>RunnerQueue</code> defines the runners where the jobs will be put into a queue and wait for its turn to run (for example, clusters).</p>
<p>Some important method to be redefined:</p>
<ul>
<li>
<p>The constructor: <code>__init__(self, job)</code><br />
    This initializes the runner using the a <code>job</code> object and the properties of the process. You would like firstly initialize some basic properties of the runner by using the super constructor: 
    <code>python
    super(RunnerMy, self).__init__(job)</code>
    Then the main purpose of the constructor is to construct the script (<code>self.script</code>) to submit the job. In <code>Runner</code>, it uses <code>utils.chmodX</code> to make it suitable for first argument of <a href="https://docs.python.org/2/library/subprocess.html#popen-constructor"><code>Popen</code></a> with <code>shell=False</code>. If the file is executable, no interpreters will be added, otherwise, the interpreter will be inferred from shebang (see <a href="https://pwwang.gitbooks.io/pyppl/content/API.html#chmodX">API</a>).
    For example, you want a delay before submitting jobs:
    <code>python
    class runnerDelay(Runner):
        def __init__ (self, job):
            super(runnerDelay, self).__init__(job)
            scriptfile = self.job.script + ".delay"
            with open (scriptfile, "w") as f:
                f.write ("#!/usr/bin/env bash\n")
                # save the pid
                f.write ("echo $$ &gt; %s" % self.job.pidfile) 
                # save the rc
                f.write ('trap "status=\\$?; echo \\$status &gt; %s; exit \\$status" 1 2 3 6 7 8 9 10 11 12 15 16 17 EXIT' % self.job.rcfile)  
                # delay for 10 seconds
                f.write ("sleep 10\n")   
                # save the stdout and stderr       
                f.write ("%s 1&gt;%s 2&gt;%s\n" % (self.cmd2run, self.job.outfile, self.job.errfile)) 
            # make it executable
            utils.chmodX(scriptfile)
            # because we don't have a local job submitter (like qsub for sge), we need to compose one
            submitfile = self.job.script + ".submit"
            with open(submitfile, 'w') as f:
                f.write('#!/usr/bin/env bash\n')
                f.write('%s\n' % scriptfile)
            # ready to submit
            self.script = utils.chmodX (submitfile)</code>
    &gt; <strong>Checklist (What you have to do in the constructor redefinition):</strong>
    &gt; - choose the right base class (<code>pyppl.runners.Runner</code> or <code>pyppl.runners.RunnerQueue</code>)
    &gt; - <code>super(RunnerMy, self).__init__(job)</code>
    &gt; - setup the right <code>self.script</code> for submission.
    &gt; - MAKE SURE you save the identity of the job to <code>job.pidfile</code>, rc to <code>job.rcfile</code>, stdout to <code>job.outfile</code> and <code>stderr</code> to <code>job.errfile</code></p>
</li>
<li>
<p>Get the job identity on the system: <code>getpid()</code>
  Sometimes you cannot determin the job identity (e.g. <code>pid</code> for local jobs) when you are composing the script file. For example, for <code>SGE</code> runner, only after you submit the job, the job id will be saved in <code>job.pidfile</code>. In this case, you have to parse the job identity from <code>job.outfile</code>. Then you may save it by <code>self.job.pid(&lt;jobid&gt;)</code>.<br />
  The purpose to save the job identity is to tell whether the job is already running before we submit the job. So you can ignore this, but the same job may be submitted twice. 
  Also see <code>isRunning</code> below.</p>
</li>
<li>
<p>Tell whether a job is still running: <code>isRunning(self)</code><br />
    This function is used to detect whether a job is running. 
    Basically, it uses the job id got by <code>getpid()</code> to tell whether the job is still running.
    <strong>This function is specially useful when you try to run the pipeline again if some of the jobs are still running but the main thread (pipeline) quite unintentionally.</strong><br />
    But it's optional, you can make the function always return <code>False</code>. Then the jobs are anyway to be submitted. In this case, <code>getpid</code> redefinition is not needed.</p>
</li>
<li>
<p>How many jobs to submit at one time (static variable): <code>maxsubmit</code> (WILL BE DEPRECATED!)
    This variable defines how many jobs to submit at one time. It defaults to <code>multiprocessing.cpu_count()/2</code> if you don't have the value for your runner, which means it will use half of the cpus to submit the jobs you want to run simultaneously at one time. Then wait for sometime (<code>interval</code>, see below), and submit another batch. The purpose is to avoid local machine to get stuck if you have too many jobs to submit.</p>
</li>
</ul>
<p><strong>Key points in writing your own runner</strong>:</p>
<ol>
<li>Choose the right base class (<code>pyppl.runners.Runner</code> or <code>pyppl.runners.RunnerQueue</code>) (required).</li>
<li>Compose the right script to submit the job (<code>self.script</code>) in <code>__init__</code>(required).</li>
<li>Use <code>getpid</code> to get the job id (optional).</li>
<li>Tell <code>PyPPL</code> how to judge when the jobs are still running (<code>self.isRunning()</code>) (optional). </li>
<li>MAKE SURE you save the identity of the job to <code>job.pidfile</code>, rc to <code>job.rcfile</code>, stdout to <code>job.outfile</code> and <code>stderr</code> to <code>job.errfile</code></li>
</ol>
<h2 id="register-your-runner">Register your runner</h2>
<p>It very easy to register your runner, just do <code>PyPPL.registerRunner (RunnerMy)</code> (static method) before you start to run the pipeline.
The 5 built-in runners have already been registered: </p>
<pre><code class="python">PyPPL.registerRunner (RunnerLocal)
PyPPL.registerRunner (RunnerSsh)
PyPPL.registerRunner (RunnerSge)
PyPPL.registerRunner (RunnerSlurm)
PyPPL.registerRunner (RunnerDry)
</code></pre>

<p>To register yours:</p>
<pre><code class="python">PyPPL.registerRunner(RunnerMy)
</code></pre>

<p>After registration, you are able to ask a process to use it: <code>pXXX.runner = "my"</code></p>
<h2 id="use-different-runners">Use different runners</h2>
<p>You can use different runners to run processes if you like. The default runner is <code>local</code>. You can change it by the configuration of the pipeline:</p>
<pre><code class="python">PyPPL(config).start(...).run()
</code></pre>

<p>The config is something like:</p>
<pre><code class="json">{
    &quot;proc&quot;: {
        &quot;runner&quot;: &quot;sge&quot;
    }
}
</code></pre>

<p>You can also set it in the default configuration file: <code>$HOME/.PyPPL.json</code>.
If you don't want to modify the configurations, to set the runner on the run:
<code>PyPPL().start(...).run("sge")</code>
Then all processes will run through <code>sge</code> runner.</p>
<p>You may also set different runners for different processes.</p>
<pre><code class="python">pXXX.runner = &quot;sge&quot;
</code></pre>

<p>Note that this will NOT be overwritten by any other configurations, which means it has the highest priority.</p>
<p>{% endraw %}</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../set-other-properties-of-a-process/" class="btn btn-neutral float-right" title="Other attributes of a process">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../caching/" class="btn btn-neutral" title="Caching and resuming processes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../caching/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../set-other-properties-of-a-process/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
