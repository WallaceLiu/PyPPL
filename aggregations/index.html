<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Aggregations - PyPPL - A Python PiPeLine framework</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../README/">PyPPL - A Python PiPeLine framework</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../README/">Introduction</a>
                    </li>
                    <li >
                        <a href="../basic-concepts-and-directory-structure/">Basics and folder structure</a>
                    </li>
                    <li >
                        <a href="../placeholders/">Templating</a>
                    </li>
                    <li >
                        <a href="../channels/">Channels</a>
                    </li>
                    <li >
                        <a href="../specify-input-and-output-of-a-process/">Input and output of a process</a>
                    </li>
                    <li >
                        <a href="../write-your-script/">The heart: script</a>
                    </li>
                    <li >
                        <a href="../export-output-files/">Output file exporting</a>
                    </li>
                    <li >
                        <a href="../caching/">Caching and resuming processes</a>
                    </li>
                    <li >
                        <a href="../runners/">Runners</a>
                    </li>
                    <li >
                        <a href="../set-other-properties-of-a-process/">Other attributes of a process</a>
                    </li>
                    <li >
                        <a href="../configure-your-logs/">Log configuration</a>
                    </li>
                    <li >
                        <a href="../configure-a-pipeline/">Pipeline configuration</a>
                    </li>
                    <li >
                        <a href="../draw-flowchart-of-a-pipeline/">Pipeline flowchart</a>
                    </li>
                    <li >
                        <a href="../command-line-argument-parser/">Command line argument parser</a>
                    </li>
                    <li class="active">
                        <a href="./">Aggregations</a>
                    </li>
                    <li >
                        <a href="../command-line-tool/">Command line tool</a>
                    </li>
                    <li >
                        <a href="../api/">API</a>
                    </li>
                    <li >
                        <a href="../faq/">FAQ</a>
                    </li>
                    <li >
                        <a href="../change-log/">Change log</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../command-line-argument-parser/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../command-line-tool/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#aggregations">Aggregations</a></li>
            <li><a href="#initialize-an-aggregation">Initialize an aggregation</a></li>
            <li><a href="#add-a-process-on-the-run">Add a process on the run</a></li>
            <li><a href="#delegate-attributes-of-processes-to-an-aggregation">Delegate attributes of processes to an aggregation</a></li>
            <li><a href="#set-an-aggregation-as-start-aggregation-for-a-pipeline">Set an aggregation as start aggregation for a pipeline</a></li>
            <li><a href="#the-dependency-of-aggregations-and-processes">The dependency of aggregations and processes</a></li>
            <li><a href="#copy-an-aggregation">Copy an aggregation</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="aggregations">Aggregations</h1>
<!-- toc -->

<p>Imagine that you have a set of processes predefined, and every time when you deal with similar problems (i.e. format a file and plot the data or some next generation sequencing data analysis), you will consistently use those processes, then you have to configure and call them every time. </p>
<p>Aggregations are designed for this kind of situations, you can just define an aggregations with those processes, and adjust the dependencies, input and arguments, you will be able to re-use the aggregation with very less configuration.</p>
<p>For example:</p>
<pre><code class="python">pTrimmomaticPE.input             = &lt;input channel&gt;
pAlignPEByBWA.depends            = pTrimmomaticPE
pSortSam.depends                 = pAlignPEByBWA
pMarkDuplicates.depends          = pSortSam
pIndexBam.depends                = pMarkDuplicates
pRealignerTargetCreator.depends  = pIndexBam
pIndelRealigner.depends          = pIndexBam, pRealignerTargetCreator
pBaseRecalibrator.depends        = pIndelRealigner
pPrintReads.depends              = pIndelRealigner, pBaseRecalibrator
pPrintReads.exportdir            = exdir

pMarkDuplicates.args.params.tmpdir   = &quot;/local2/tmp/&quot;
pAlignPEByBWA.args.reffile           = reffile
pRealignerTargetCreator.args.reffile = reffile
pRealignerTargetCreator.args.params.tmpdir='/local2/tmp/'
pIndelRealigner.args.reffile         = reffile
pIndelRealigner.args.params.tmpdir   = '/local2/tmp/'
pBaseRecalibrator.args.reffile       = reffile
pBaseRecalibrator.args.knownSites    = dbsnp
pBaseRecalibrator.args.params.tmpdir ='/local2/tmp/'
pPrintReads.args.reffile             = reffile
pPrintReads.args.params              = '/local2/tmp/'

PyPPL({
    'proc': {
        'forks': 100,
        'runner': 'sge',
        'sgeRunner': {
            'sge.q': 'lg-mem'
        }
    }
}).start(pTrimmomaticPE).run()
</code></pre>

<p>This is a very commonly used Whole Genome Sequencing data cleanup pipeline from the raw reads according to the <a href="https://software.broadinstitute.org/gatk/best-practices/">GATK best practice</a>. And it will be used pretty much every time when the raw read files come. </p>
<p>With an aggregation defined, you don't need to configure and call those processes every time:</p>
<pre><code class="python">from pyppl import Aggr
from bioprocs import params
# some paramters defined in params
aFastqPE2Bam = Aggr (
    pTrimmomaticPE,
    pAlignPEByBWA,
    pSortSam,
    pMarkDuplicates,
    pIndexBam,
    pRealignerTargetCreator,
    pIndelRealigner,
    pBaseRecalibrator,
    pPrintReads
)
# dependency adjustment
aFastqPE2Bam.pIndelRealigner.depends   = aFastqPE2Bam.pIndexBam, aFastqPE2Bam.pRealignerTargetCreator
aFastqPE2Bam.pPrintReads.depends       = aFastqPE2Bam.pIndelRealigner, aFastqPE2Bam.pBaseRecalibrator
# input adjustment
# args adjustment
aFastqPE2Bam.pMarkDuplicates.args.params.tmpdir       = params.tmpdir
aFastqPE2Bam.pAlignPEByBWA.args.reffile               = params.hg19fa
aFastqPE2Bam.pRealignerTargetCreator.args.reffile     = params.hg19fa
aFastqPE2Bam.pRealignerTargetCreator.args.params.tmpdir= params.tmpdir
aFastqPE2Bam.pIndelRealigner.args.reffile             = params.hg19fa
aFastqPE2Bam.pIndelRealigner.args.params.tmpdir       = params.tmpdir
aFastqPE2Bam.pBaseRecalibrator.args.reffile           = params.hg19fa
aFastqPE2Bam.pBaseRecalibrator.args.knownSites        = params.dbsnp
aFastqPE2Bam.pBaseRecalibrator.args.params.tmpdir     = params.tmpdir
aFastqPE2Bam.pPrintReads.args.reffile                 = params.hg19fa
aFastqPE2Bam.pPrintReads.args.params.tmpdir           = params.tmpdir
</code></pre>

<p>Then every time you just need to call the aggregation:</p>
<pre><code class="python">aFastqPE2Bam.input = channel.fromPairs ( datadir + '/*.fastq.gz' )
aFastqPE2Bam.exdir = exdir
PyPPL({
    'proc': {
        'sgeRunner': {
            'sge.q' : '1-day'
        }
    }
}).start(aFastqPE2Bam).run()
</code></pre>

<h2 id="initialize-an-aggregation">Initialize an aggregation</h2>
<p>Like previous example shows, you just need to give the constructor all the processes to construct an aggretation. However, there are several things need to be noticed:</p>
<ol>
<li>The dependencies are automatically constructed by the order of the processes. 
   <code>python
   a = Aggr (p1, p2, p3)
   # The dependencies will be p1 -&gt; p2 -&gt; p3</code></li>
<li>The starting and ending processes are defined as the first and last processes, respectively. If you need to modify the dependencies, keep that in mind whether the starting and ending processes are changed.
    <code>python
    a = Aggr (p1, p2, p3)
    # a.starts == [p1]
    # a.ends   == [p3]
    #                                / p2
    # change the dependencies to  p1      &gt;
    #                                \ p3
    # both p2, p3 depend on p1, and p3 depends on p2
    a.p3.depends = p1, p2
    # but remember the ending processes are changed from [p3] to [p2, p3]
    a.ends = [p2, p3]</code>
    You can also specify the dependencies manually:
    <code>python
    a = Aggr (p1, p2, p3, depends = False)
    a.p2.depends = p1
    a.p3.depends = p1, p2
    a.starts = [p1]
    a.ends   = [p2, p3]</code></li>
<li>If you have one process used twice in the aggregation, copy it with a different id:
   <code>python
   a = Aggr(
       p1,
       p2,
       p1.copy(newid = 'p1copy')
   )
   # then to access the 2nd p1: a.p1copy</code></li>
<li>Each process is copied by aggregation, so the original one can still be used.</li>
<li>The tag of each process is regenerated by the id of the aggregation.</li>
</ol>
<h2 id="add-a-process-on-the-run">Add a process on the run</h2>
<p><code>aggr.addProc(p, where=None)</code>
You can add a process, and also define whether to put it in <code>starts</code>, <code>ends</code>, <code>both</code> or <code>None</code>.</p>
<h2 id="delegate-attributes-of-processes-to-an-aggregation">Delegate attributes of processes to an aggregation</h2>
<p>You can Delegate the attributes directly for a process to an aggregation:</p>
<pre><code class="python">aFastqPE2Bam.delegate('args.reffile', 'pAlignPEByBWA')
</code></pre>

<p>Then when you want to set <code>args.reffile</code> for <code>pAlignPEByBWA</code>, you can just do:</p>
<pre><code class="python">aFastqPE2Bam.args.reffile = '/path/to/hg19.fa'
</code></pre>

<p>You may use <code>starts/ends</code> represents the start/end processes.
You may also set an alias for the attribute:</p>
<pre><code class="python">aFastqPE2Bam.delegate('align_ref', 'pAlignPEByBWA', 'args.reffile')
</code></pre>

<p>Then to set the value:</p>
<pre><code class="python">aFastqPE2Bam.align_ref = '/path/to/hg19.fa'
</code></pre>

<h2 id="set-an-aggregation-as-start-aggregation-for-a-pipeline">Set an aggregation as start aggregation for a pipeline</h2>
<p>You can do it just like setting a process as the starting process of pipeline (see <a href="https://pwwang.gitbooks.io/pyppl/configure-a-pipeline.html#starting-processes">here</a>). Actually the starting processes in the aggregation (<code>aggr.starts</code>) will be set as the starting processes of the pipeline.</p>
<h2 id="the-dependency-of-aggregations-and-processes">The dependency of aggregations and processes</h2>
<p>An aggregation can depend on aggregations and/or processes, you just treat the aggregations as processes. A process can also depend on aggregations and/or processes. </p>
<table>
<thead>
<tr>
<th>What am I?</th>
<th>Whom I am depending on?</th>
<th>Real relations</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Aggr</code> (<code>a1</code>)</td>
<td><code>Aggr</code> (<code>a2</code>)</td>
<td><code>a1.starts</code> depends on <code>a2.ends</code></td>
</tr>
<tr>
<td><code>Proc</code> (<code>p</code>)</td>
<td><code>Aggr</code> (<code>a</code>)</td>
<td><code>p</code> depends on <code>a.ends</code></td>
</tr>
<tr>
<td>&gt; <strong>Note</strong> You have to specify <code>depends</code> for start processes of an aggregation.</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="copy-an-aggregation">Copy an aggregation</h2>
<p><code>Aggr.copy(tag = 'notag', copyDeps = True, newid = None)</code>
You may copy an aggregation, all the processes in the aggregation will be copied, and the dependencies will be switched to the corresponding copied processes, as well as the starting and ending processes, if <code>copyDeps == True</code>. </p>
<p>You can keep the ids of processes unchanged but give a new tag and also give the aggregation an new id instead of the variable name:</p>
<pre><code class="python">a = Aggr(p1, p2, p3)
# access the processes:
# a.p1, a.p2, a.p3
a2 = a.copy('copied')
# a2.procs == [
# &lt;proc with id &quot;p1&quot; and tag &quot;copied&quot;&gt;,
# &lt;proc with id &quot;p2&quot; and tag &quot;copied&quot;&gt;,
# &lt;proc with id &quot;p3&quot; and tag &quot;copied&quot;&gt;,
# ]
# a2.id == 'a2'
# to access the processes:
# a2.p1, a2.p2, a2.p3
a2 = a.copy('copied', newid = 'newAggr')
# a2.id == 'newAggr'
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script src="../js/base.js"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
